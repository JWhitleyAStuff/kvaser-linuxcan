<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Kvaser Linux CANLIB: simplewrite.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top">

  <div id="titlearea">
    <table cellspacing="0" cellpadding="0">
     <tbody>

       <tr style="height: 56px;">
         <td><a border="0" href="http://www.kvaser.com"><img border="0"  src="./kvaser.gif"></a></td>
         <td style="padding-left: 1.5em;">
           <div id="projectname">Kvaser Linux CANLIB: simplewrite.c<br/></div>
         </td>
       </tr>
     </tbody>
    </table>
  </div>
  
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('simplewrite_8c-example.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>simplewrite.c</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment">**             Copyright 2012-2016 by Kvaser AB, Molndal, Sweden</span>
<span class="comment">**                        http://www.kvaser.com</span>
<span class="comment">**</span>
<span class="comment">** This software is dual licensed under the following two licenses:</span>
<span class="comment">** BSD-new and GPLv2. You may use either one. See the included</span>
<span class="comment">** COPYING file for details.</span>
<span class="comment">**</span>
<span class="comment">** License: BSD-new</span>
<span class="comment">** ===============================================================================</span>
<span class="comment">** Redistribution and use in source and binary forms, with or without</span>
<span class="comment">** modification, are permitted provided that the following conditions are met:</span>
<span class="comment">**     * Redistributions of source code must retain the above copyright</span>
<span class="comment">**       notice, this list of conditions and the following disclaimer.</span>
<span class="comment">**     * Redistributions in binary form must reproduce the above copyright</span>
<span class="comment">**       notice, this list of conditions and the following disclaimer in the</span>
<span class="comment">**       documentation and/or other materials provided with the distribution.</span>
<span class="comment">**     * Neither the name of the &lt;organization&gt; nor the</span>
<span class="comment">**       names of its contributors may be used to endorse or promote products</span>
<span class="comment">**       derived from this software without specific prior written permission.</span>
<span class="comment">**</span>
<span class="comment">** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<span class="comment">** ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="comment">** WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="comment">** DISCLAIMED. IN NO EVENT SHALL &lt;COPYRIGHT HOLDER&gt; BE LIABLE FOR ANY</span>
<span class="comment">** DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="comment">** (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="comment">** LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<span class="comment">** ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="comment">** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="comment">** SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="comment">**</span>
<span class="comment">**</span>
<span class="comment">** License: GPLv2</span>
<span class="comment">** ===============================================================================</span>
<span class="comment">** This program is free software; you can redistribute it and/or</span>
<span class="comment">** modify it under the terms of the GNU General Public License</span>
<span class="comment">** as published by the Free Software Foundation; either version 2</span>
<span class="comment">** of the License, or (at your option) any later version.</span>
<span class="comment">**</span>
<span class="comment">** This program is distributed in the hope that it will be useful,</span>
<span class="comment">** but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment">** GNU General Public License for more details.</span>
<span class="comment">**</span>
<span class="comment">** You should have received a copy of the GNU General Public License</span>
<span class="comment">** along with this program; if not, write to the Free Software</span>
<span class="comment">** Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="comment">**</span>
<span class="comment">** ---------------------------------------------------------------------------</span>
<span class="comment">**/</span>

<span class="comment">/*</span>
<span class="comment"> * Kvaser Linux Canlib</span>
<span class="comment"> * Send a CAN message</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;<a class="code" href="canlib_8h.html">canlib.h</a>&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;signal.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>
<span class="preprocessor">#include &lt;unistd.h&gt;</span>
<span class="preprocessor">#include &quot;vcanevt.h&quot;</span>


<span class="keyword">static</span> <span class="keywordtype">void</span> check(<span class="keywordtype">char</span>* <span class="keywordtype">id</span>, <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7">canStatus</a> stat)
{
  <span class="keywordflow">if</span> (stat != <a name="a0"></a><a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordtype">char</span> buf[50];
    buf[0] = <span class="charliteral">&#39;\0&#39;</span>;
    <a name="a1"></a><a class="code" href="group___general.html#ga01a7a415c95c579750bcdd95a1d245c4">canGetErrorText</a>(stat, buf, <span class="keyword">sizeof</span>(buf));
    printf(<span class="stringliteral">&quot;%s: failed, stat=%d (%s)\n&quot;</span>, <span class="keywordtype">id</span>, (<span class="keywordtype">int</span>)stat, buf);
  }
}

<span class="keyword">static</span> <span class="keywordtype">void</span> printUsageAndExit(<span class="keywordtype">char</span> *prgName)
{
  printf(<span class="stringliteral">&quot;Usage: &#39;%s &lt;channel&gt;&#39;\n&quot;</span>, prgName);
  exit(1);
}

<span class="keyword">static</span> <span class="keywordtype">char</span>* busStatToStr(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flag) {
    <span class="keywordtype">char</span>* tempStr = NULL;
<span class="preprocessor">    #define MACRO2STR(x) case x: tempStr = #x; break</span>
<span class="preprocessor"></span>    <span class="keywordflow">switch</span> (flag) {
        MACRO2STR( CHIPSTAT_BUSOFF        );
        MACRO2STR( CHIPSTAT_ERROR_PASSIVE );
        MACRO2STR( CHIPSTAT_ERROR_WARNING );
        MACRO2STR( CHIPSTAT_ERROR_ACTIVE  );
        <span class="keywordflow">default</span>: tempStr = <span class="stringliteral">&quot;&quot;</span>; <span class="keywordflow">break</span>;
    }
<span class="preprocessor">    #undef MACRO2STR</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> tempStr;
}

<span class="keywordtype">void</span> notifyCallback(<a name="_a2"></a><a class="code" href="structcan_notify_data.html">canNotifyData</a> *data) {
  <span class="keywordflow">switch</span> (data-&gt;<a name="a3"></a><a class="code" href="structcan_notify_data.html#aa73ed1819d01004c05b8b1908ef91ef4">eventType</a>) {
  <span class="keywordflow">case</span> <a name="a4"></a><a class="code" href="canstat_8h.html#a0c59f7bbcb5cceaefe0d1d5915e8b4fc" title="when the CAN controller changes state">canEVENT_STATUS</a>:
    printf(<span class="stringliteral">&quot;CAN Status Event: %s\n&quot;</span>, busStatToStr(data-&gt;<a name="a5"></a><a class="code" href="structcan_notify_data.html#ae129dc8383274d477e1709e2df4a4d74">info</a>.<a name="a6"></a><a class="code" href="structcan_notify_data.html#a345c20017f48fbb3fb2b3adada292f29">status</a>.busStatus));
    <span class="keywordflow">break</span>;
  <span class="keywordflow">case</span> <a name="a7"></a><a class="code" href="canstat_8h.html#a5a6431078d49d8f7cc36c6313db44406" title="when a CAN bus error is reported by the CAN controller">canEVENT_ERROR</a>:
    printf(<span class="stringliteral">&quot;CAN Error Event\n&quot;</span>);
    <span class="keywordflow">break</span>;
  <span class="keywordflow">case</span> <a name="a8"></a><a class="code" href="canstat_8h.html#a21669303d34190235f63303deae6b248" title="when a CAN message has been transmitted">canEVENT_TX</a>:
    printf(<span class="stringliteral">&quot;CAN Tx Event\n&quot;</span>);
    <span class="keywordflow">break</span>;
  <span class="keywordflow">case</span> <a name="a9"></a><a class="code" href="canstat_8h.html#af5f5917ba5476570815747b960e26ba6" title="when the queue of received CAN messages goes from empty to non-empty">canEVENT_RX</a>:
    printf(<span class="stringliteral">&quot;CAN Rx Event\n&quot;</span>);
    <span class="keywordflow">break</span>;
  }
  <span class="keywordflow">return</span>;
}


<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  <a class="code" href="canlib_8h.html#ae3d1b041d62207d5336f93c089cd5b65">canHandle</a> hnd;
  <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7">canStatus</a> stat;
  <span class="keywordtype">int</span> channel;

  <span class="keywordflow">if</span> (argc != 2) {
    printUsageAndExit(argv[0]);
  }

  {
    <span class="keywordtype">char</span> *endPtr = NULL;
    errno = 0;
    channel = strtol(argv[1], &amp;endPtr, 10);
    <span class="keywordflow">if</span> ( (errno != 0) || ((channel == 0) &amp;&amp; (endPtr == argv[1])) ) {
      printUsageAndExit(argv[0]);
    }
  }

  printf(<span class="stringliteral">&quot;Sending a message on channel %d\n&quot;</span>, channel);

  <span class="comment">/* Open channel, set parameters and go on bus */</span>

  hnd = <a name="a10"></a><a class="code" href="group___c_a_n.html#gac377d182232fb4ec2fed881c2b9ab300">canOpenChannel</a>(channel, <a name="a11"></a><a class="code" href="canlib_8h.html#afacd9e186d273d0dc24956ea0d433822">canOPEN_EXCLUSIVE</a> | <a name="a12"></a><a class="code" href="canlib_8h.html#a161c14f3b9d1e5cff276c6246a651fcd">canOPEN_REQUIRE_EXTENDED</a> | <a name="a13"></a><a class="code" href="canlib_8h.html#a8e4ead14e67e49e27674c706e0d88f23">canOPEN_ACCEPT_VIRTUAL</a>);
  <span class="keywordflow">if</span> (hnd &lt; 0) {
    printf(<span class="stringliteral">&quot;canOpenChannel %d&quot;</span>, channel);
    check(<span class="stringliteral">&quot;&quot;</span>, hnd);
    <span class="keywordflow">return</span> -1;
  }

  stat = <a name="a14"></a><a class="code" href="group___c_a_n.html#ga7eb8c2e92cfae57e7ec5031818524301">canSetBusParams</a>(hnd, <a name="a15"></a><a class="code" href="canlib_8h.html#ac823cae7d94763607a7ca40fcdb5196d">canBITRATE_1M</a>, 0, 0, 0, 0, 0);
  check(<span class="stringliteral">&quot;canSetBusParams&quot;</span>, stat);
  <span class="keywordflow">if</span> (stat != <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordflow">goto</span> ErrorExit;
  }

  stat = <a name="a16"></a><a class="code" href="group___c_a_n.html#gaa5dd0f277c7059169055321fbda87486">canSetNotify</a>(hnd, notifyCallback, <a name="a17"></a><a class="code" href="canstat_8h.html#af0b2b8979177da5f9c875f584f9c7d9c" title="CAN message reception notification.">canNOTIFY_RX</a> | <a name="a18"></a><a class="code" href="canstat_8h.html#a14e966f0b3f498285fb332632df60a88" title="CAN message transmission notification.">canNOTIFY_TX</a> | <a name="a19"></a><a class="code" href="canstat_8h.html#a91afcc669b1b8be0ed390aac37e44805" title="CAN bus error notification.">canNOTIFY_ERROR</a> | <a name="a20"></a><a class="code" href="canstat_8h.html#ae04b14c6acacd116cceaf78abc8b02c0" title="CAN chip status change.">canNOTIFY_STATUS</a> | <a name="a21"></a><a class="code" href="canstat_8h.html#ab69dc959890826b245c422966c4bf627" title="An environment variable was changed by a script.">canNOTIFY_ENVVAR</a>, (<span class="keywordtype">char</span>*)0);
  check(<span class="stringliteral">&quot;canSetNotify&quot;</span>, stat);

  stat = <a name="a22"></a><a class="code" href="group___c_a_n.html#ga99c7c99cc71580f8099a1407f4f9ea1a">canBusOn</a>(hnd);
  check(<span class="stringliteral">&quot;canBusOn&quot;</span>, stat);
  <span class="keywordflow">if</span> (stat != <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordflow">goto</span> ErrorExit;
  }

  stat = <a name="a23"></a><a class="code" href="group___c_a_n.html#ga62c185329d6741c90102511e2f37983e">canWrite</a>(hnd, 10000, <span class="stringliteral">&quot;Kvaser!&quot;</span>, 8, 0);
  check(<span class="stringliteral">&quot;canWrite&quot;</span>, stat);
  <span class="keywordflow">if</span> (stat != <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordflow">goto</span> ErrorExit;
  }
  stat = <a name="a24"></a><a class="code" href="group___c_a_n.html#ga304cb3a7bc2874c1f8ad361a911bcd5f">canWriteSync</a>(hnd, 1000);
  check(<span class="stringliteral">&quot;canWriteSync&quot;</span>, stat);
  <span class="keywordflow">if</span> (stat != <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordflow">goto</span> ErrorExit;
  }

ErrorExit:

  stat = <a name="a25"></a><a class="code" href="group___c_a_n.html#gaf1786cfbfd542b18b9c599d278837bd9">canBusOff</a>(hnd);
  check(<span class="stringliteral">&quot;canBusOff&quot;</span>, stat);
  usleep(50*1000); <span class="comment">// Sleep just to get the last notification.</span>
  stat = <a name="a26"></a><a class="code" href="group___c_a_n.html#ga49525373a4d08d93c651ec10f79dd36b">canClose</a>(hnd);
  check(<span class="stringliteral">&quot;canClose&quot;</span>, stat);

  <span class="keywordflow">return</span> 0;
}





</pre></div> </div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!-- <hr class="footer"/> -->
<address class="footer">
<small>Kvaser Linux CANLIB (canlib 5.17) - Generated on Thu Sep 15 2016</small>
</address>
</body>
</html>
