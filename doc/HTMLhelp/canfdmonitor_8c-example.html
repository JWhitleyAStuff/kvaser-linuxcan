<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Kvaser Linux CANLIB: canfdmonitor.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top">

  <div id="titlearea">
    <table cellspacing="0" cellpadding="0">
     <tbody>

       <tr style="height: 56px;">
         <td><a border="0" href="http://www.kvaser.com"><img border="0"  src="./kvaser.gif"></a></td>
         <td style="padding-left: 1.5em;">
           <div id="projectname">Kvaser Linux CANLIB: canfdmonitor.c<br/></div>
         </td>
       </tr>
     </tbody>
    </table>
  </div>
  
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('canfdmonitor_8c-example.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>canfdmonitor.c</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment">**             Copyright 2012-2016 by Kvaser AB, Molndal, Sweden</span>
<span class="comment">**                        http://www.kvaser.com</span>
<span class="comment">**</span>
<span class="comment">** This software is dual licensed under the following two licenses:</span>
<span class="comment">** BSD-new and GPLv2. You may use either one. See the included</span>
<span class="comment">** COPYING file for details.</span>
<span class="comment">**</span>
<span class="comment">** License: BSD-new</span>
<span class="comment">** ===============================================================================</span>
<span class="comment">** Redistribution and use in source and binary forms, with or without</span>
<span class="comment">** modification, are permitted provided that the following conditions are met:</span>
<span class="comment">**     * Redistributions of source code must retain the above copyright</span>
<span class="comment">**       notice, this list of conditions and the following disclaimer.</span>
<span class="comment">**     * Redistributions in binary form must reproduce the above copyright</span>
<span class="comment">**       notice, this list of conditions and the following disclaimer in the</span>
<span class="comment">**       documentation and/or other materials provided with the distribution.</span>
<span class="comment">**     * Neither the name of the &lt;organization&gt; nor the</span>
<span class="comment">**       names of its contributors may be used to endorse or promote products</span>
<span class="comment">**       derived from this software without specific prior written permission.</span>
<span class="comment">**</span>
<span class="comment">** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<span class="comment">** ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="comment">** WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="comment">** DISCLAIMED. IN NO EVENT SHALL &lt;COPYRIGHT HOLDER&gt; BE LIABLE FOR ANY</span>
<span class="comment">** DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="comment">** (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="comment">** LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<span class="comment">** ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="comment">** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="comment">** SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="comment">**</span>
<span class="comment">**</span>
<span class="comment">** License: GPLv2</span>
<span class="comment">** ===============================================================================</span>
<span class="comment">** This program is free software; you can redistribute it and/or</span>
<span class="comment">** modify it under the terms of the GNU General Public License</span>
<span class="comment">** as published by the Free Software Foundation; either version 2</span>
<span class="comment">** of the License, or (at your option) any later version.</span>
<span class="comment">**</span>
<span class="comment">** This program is distributed in the hope that it will be useful,</span>
<span class="comment">** but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment">** GNU General Public License for more details.</span>
<span class="comment">**</span>
<span class="comment">** You should have received a copy of the GNU General Public License</span>
<span class="comment">** along with this program; if not, write to the Free Software</span>
<span class="comment">** Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="comment">**</span>
<span class="comment">** ---------------------------------------------------------------------------</span>
<span class="comment">**/</span>

<span class="comment">/*</span>
<span class="comment"> * Kvaser Linux Canlib</span>
<span class="comment"> * Read CAN FD messages and print out their contents</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;<a class="code" href="canlib_8h.html">canlib.h</a>&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;signal.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>
<span class="preprocessor">#include &lt;unistd.h&gt;</span>


<span class="preprocessor">#define ALARM_INTERVAL_IN_S   (1)</span>
<span class="preprocessor"></span><span class="preprocessor">#define READ_WAIT_INFINITE    (unsigned long)(-1)</span>
<span class="preprocessor"></span>

<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> msgCounter;


<span class="keyword">static</span> <span class="keywordtype">void</span> check(<span class="keywordtype">char</span>* <span class="keywordtype">id</span>, <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7">canStatus</a> stat)
{
  <span class="keywordflow">if</span> (stat != <a name="a0"></a><a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordtype">char</span> buf[50];
    buf[0] = <span class="charliteral">&#39;\0&#39;</span>;
    <a name="a1"></a><a class="code" href="group___general.html#ga01a7a415c95c579750bcdd95a1d245c4">canGetErrorText</a>(stat, buf, <span class="keyword">sizeof</span>(buf));
    printf(<span class="stringliteral">&quot;%s: failed, stat=%d (%s)\n&quot;</span>, <span class="keywordtype">id</span>, (<span class="keywordtype">int</span>)stat, buf);
  }
}

<span class="keyword">static</span> <span class="keywordtype">void</span> printUsageAndExit(<span class="keywordtype">char</span> *prgName)
{
  printf(<span class="stringliteral">&quot;Usage: &#39;%s &lt;channel&gt;&#39;\n&quot;</span>, prgName);
  exit(1);
}

<span class="keyword">static</span> <span class="keywordtype">void</span> sighand(<span class="keywordtype">int</span> sig)
{
  <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> last;

  <span class="keywordflow">switch</span> (sig) {
  <span class="keywordflow">case</span> SIGINT:
    <span class="keywordflow">break</span>;
  <span class="keywordflow">case</span> SIGALRM:
    <span class="keywordflow">if</span> (msgCounter != last) {
      printf(<span class="stringliteral">&quot;rx : %d total: %d\n&quot;</span>, msgCounter - last, msgCounter);
    }
    last = msgCounter;
    alarm(ALARM_INTERVAL_IN_S);
    <span class="keywordflow">break</span>;
  }
}


<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  <a class="code" href="canlib_8h.html#ae3d1b041d62207d5336f93c089cd5b65">canHandle</a> hnd;
  <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7">canStatus</a> stat;
  <span class="keywordtype">int</span> channel;

  <span class="keywordflow">if</span> (argc != 2) {
    printUsageAndExit(argv[0]);
  }

  {
    <span class="keywordtype">char</span> *endPtr = NULL;
    errno = 0;
    channel = strtol(argv[1], &amp;endPtr, 10);
    <span class="keywordflow">if</span> ( (errno != 0) || ((channel == 0) &amp;&amp; (endPtr == argv[1])) ) {
      printUsageAndExit(argv[0]);
    }
  }

  printf(<span class="stringliteral">&quot;Reading messages on channel %d\n&quot;</span>, channel);

  <span class="comment">/* Use sighand as our signal handler */</span>
  signal(SIGALRM, sighand);
  signal(SIGINT, sighand);

  <span class="comment">/* Allow signals to interrupt syscalls */</span>
  siginterrupt(SIGINT, 1);

  <span class="comment">/* Open channels, parameters and go on bus */</span>
  hnd = <a name="a2"></a><a class="code" href="group___c_a_n.html#gac377d182232fb4ec2fed881c2b9ab300">canOpenChannel</a>(channel, <a name="a3"></a><a class="code" href="canlib_8h.html#a10aad075bfb9891aa98cf3c131977dc3">canOPEN_CAN_FD</a>);
  <span class="keywordflow">if</span> (hnd &lt; 0) {
    printf(<span class="stringliteral">&quot;canOpenChannel %d&quot;</span>, channel);
    check(<span class="stringliteral">&quot;&quot;</span>, hnd);
    <span class="keywordflow">return</span> -1;
  }

  stat = <a name="a4"></a><a class="code" href="group___c_a_n.html#ga7eb8c2e92cfae57e7ec5031818524301">canSetBusParams</a>(hnd, <a name="a5"></a><a class="code" href="canlib_8h.html#a3a93c64ba76ebe3c5e525d4dfa4ade8d">canFD_BITRATE_1M_80P</a>, 0, 0, 0, 0, 0);
  check(<span class="stringliteral">&quot;canSetBusParams&quot;</span>, stat);
  <span class="keywordflow">if</span> (stat != <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordflow">goto</span> ErrorExit;
  }
  stat = <a name="a6"></a><a class="code" href="group___c_a_n.html#gafcd85fbac103dcb123f4cd609be6fa14">canSetBusParamsFd</a>(hnd, <a name="a7"></a><a class="code" href="canlib_8h.html#a9f21214c84dbb6f5f37eb27520ecc162">canFD_BITRATE_2M_80P</a>, 0, 0, 0);
  check(<span class="stringliteral">&quot;canSetBusParamsFd&quot;</span>, stat);
  <span class="keywordflow">if</span> (stat != <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordflow">goto</span> ErrorExit;
  }
  stat = <a name="a8"></a><a class="code" href="group___c_a_n.html#ga99c7c99cc71580f8099a1407f4f9ea1a">canBusOn</a>(hnd);
  check(<span class="stringliteral">&quot;canBusOn&quot;</span>, stat);
  <span class="keywordflow">if</span> (stat != <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
    <span class="keywordflow">goto</span> ErrorExit;
  }

  alarm(ALARM_INTERVAL_IN_S);

  <span class="keywordflow">do</span> {
    <span class="keywordtype">long</span> id;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> msg[64];
    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dlc;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flag;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> time;

    stat = <a name="a9"></a><a class="code" href="group___c_a_n.html#gac01f98e282609b5f6aaf2b1eabfb83ec">canReadWait</a>(hnd, &amp;<span class="keywordtype">id</span>, &amp;msg, &amp;dlc, &amp;flag, &amp;time, READ_WAIT_INFINITE);

    <span class="keywordflow">if</span> (stat == <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>) {
      <span class="keywordtype">char</span> *can_std;
      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;

      msgCounter++;
      <span class="keywordflow">if</span> (flag &amp; <a name="a10"></a><a class="code" href="canstat_8h.html#ade1b8ed815a4bc6ada6ec666e48e9cf8" title="Message is an error frame.">canMSG_ERROR_FRAME</a>) {
        printf(<span class="stringliteral">&quot;(%u) ERROR FRAME flags:0x%x time:%lu\n&quot;</span>, msgCounter, flag, time);
        <span class="keywordflow">continue</span>;
      }

      <span class="keywordflow">if</span> (flag &amp; <a name="a11"></a><a class="code" href="canstat_8h.html#adb943d749cf5d08a964ed00dc8df8435" title="Message is an FD message (CAN FD)">canFDMSG_FDF</a>) {
        <span class="keywordflow">if</span> (flag &amp; <a name="a12"></a><a class="code" href="canstat_8h.html#a20c4f6ae319558189eb85d10036e9eea" title="Message is sent/received with bit rate switch (CAN FD)">canFDMSG_BRS</a>) {
          can_std = <span class="stringliteral">&quot;FD+&quot;</span>;
          }
        <span class="keywordflow">else</span> {
          can_std = <span class="stringliteral">&quot;FD &quot;</span>;
        }
      }
      <span class="keywordflow">else</span> {
        can_std = <span class="stringliteral">&quot;STD&quot;</span>;
      }

      printf(<span class="stringliteral">&quot;CH:%2d %s:%s:%2u:%08lx&quot;</span>, channel,
             can_std,
             (flag &amp; <a name="a13"></a><a class="code" href="canstat_8h.html#ade936f23b4b303d64187b4c6589c9c10" title="Message has an extended ID.">canMSG_EXT</a>) ? <span class="stringliteral">&quot;X&quot;</span> : <span class="stringliteral">&quot; &quot;</span>,
             dlc,<span class="keywordtype">id</span>);

      <span class="keywordflow">if</span> (flag &amp; <a name="a14"></a><a class="code" href="canstat_8h.html#aa50c93236b2b28677bcae0f7c1ab3860" title="Sender of the message is in error passive mode (CAN FD)">canFDMSG_ESI</a>) {
        printf(<span class="stringliteral">&quot;ESI &quot;</span>);
      }

      printf(<span class="stringliteral">&quot; flags:0x%x time:%lu&quot;</span>, flag, time);

      <span class="keywordflow">for</span> (i = 0; i &lt; dlc; i++) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> byte = msg[i];

        <span class="keywordflow">if</span> ((i % 16) == 0) {
          printf(<span class="stringliteral">&quot;\n    &quot;</span>);
        }
        printf(<span class="stringliteral">&quot; %02x &quot;</span>, byte);
      }
      printf(<span class="stringliteral">&quot;\n&quot;</span>);
    } 
    <span class="keywordflow">else</span> {
      <span class="keywordflow">if</span> (errno == 0) {
        check(<span class="stringliteral">&quot;\ncanReadWait&quot;</span>, stat);
      }
      <span class="keywordflow">else</span> {
        perror(<span class="stringliteral">&quot;\ncanReadWait error&quot;</span>);
      }
    }

  } <span class="keywordflow">while</span> (stat == <a class="code" href="canstat_8h.html#a52b5e5c71832b0bd3c6a5b1fd48583e7a49743d0d438957118b9c6af2e831b209">canOK</a>);

  sighand(SIGALRM);

ErrorExit:

  alarm(0);
  stat = <a name="a15"></a><a class="code" href="group___c_a_n.html#gaf1786cfbfd542b18b9c599d278837bd9">canBusOff</a>(hnd);
  check(<span class="stringliteral">&quot;canBusOff&quot;</span>, stat);
  stat = <a name="a16"></a><a class="code" href="group___c_a_n.html#ga49525373a4d08d93c651ec10f79dd36b">canClose</a>(hnd);
  check(<span class="stringliteral">&quot;canClose&quot;</span>, stat);

  <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!-- <hr class="footer"/> -->
<address class="footer">
<small>Kvaser Linux CANLIB (canlib 5.19) - Generated on Wed Feb 15 2017</small>
</address>
</body>
</html>
